/*
 * Minesweeper for GameBoy (compile with GBDK)
 * Copyright (C)2000 Mattias Wadman <mattias.wadman@gmail.com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
 *
 * 
 * Images generated with PPM by Ville Helin <vhelin@cc.hut.fi>
 * http://www.hut.fi/~vhelin/ppm.html
 * 
 * Last modified: 001227 20:50
 * 
 */

#include <stdlib.h>
#include <gb.h>

#define IMAGE_0		0
#define IMAGE_1		1
#define IMAGE_2		2
#define IMAGE_3		3
#define IMAGE_4		4
#define IMAGE_5		5
#define IMAGE_6		6
#define IMAGE_7		7
#define IMAGE_8		8
#define IMAGE_MINE	9
#define IMAGE_BOOM	10
#define IMAGE_MISSED	11
#define IMAGE_UNSWEEPED	12
#define IMAGE_UNSURE	13
#define IMAGE_MARK	14
#define IMAGE_POINTER	15
#define IMAGE_BG	16
#define SEEK_POINTS	8	
#define _MOVE_POINTER(x,y) move_sprite(0,x+8,y+16)

unsigned char game_images[] =
{
0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x55, 0x00,
0x00, 0x00, 0x11, 0x10, 0x30, 0x30, 0x11, 0x10,
0x10, 0x10, 0x39, 0x38, 0x00, 0x00, 0x55, 0x00,
0x00, 0x00, 0x39, 0x38, 0x08, 0x08, 0x39, 0x38,
0x20, 0x20, 0x39, 0x38, 0x00, 0x00, 0x55, 0x00,
0x00, 0x00, 0x39, 0x38, 0x08, 0x08, 0x19, 0x18,
0x08, 0x08, 0x39, 0x38, 0x00, 0x00, 0x55, 0x00,
0x00, 0x00, 0x29, 0x28, 0x28, 0x28, 0x3d, 0x3c,
0x08, 0x08, 0x09, 0x08, 0x00, 0x00, 0x55, 0x00,
0x00, 0x00, 0x39, 0x38, 0x20, 0x20, 0x39, 0x38,
0x08, 0x08, 0x39, 0x38, 0x00, 0x00, 0x55, 0x00,
0x00, 0x00, 0x39, 0x38, 0x20, 0x20, 0x39, 0x38,
0x28, 0x28, 0x39, 0x38, 0x00, 0x00, 0x55, 0x00,
0x00, 0x00, 0x39, 0x38, 0x08, 0x08, 0x1d, 0x1c,
0x08, 0x08, 0x09, 0x08, 0x00, 0x00, 0x55, 0x00,
0x00, 0x00, 0x39, 0x38, 0x28, 0x28, 0x39, 0x38,
0x28, 0x28, 0x39, 0x38, 0x00, 0x00, 0x55, 0x00,
0x00, 0x00, 0x11, 0x00, 0x38, 0x10, 0x79, 0x3c,
0x30, 0x18, 0x01, 0x10, 0x00, 0x00, 0x55, 0x00,
0xfe, 0x00, 0xef, 0x10, 0xd6, 0x38, 0xbb, 0x7c,
0xd6, 0x38, 0xef, 0x10, 0xfe, 0x00, 0x55, 0x00,
0x00, 0x00, 0x45, 0x44, 0x28, 0x28, 0x11, 0x10,
0x28, 0x28, 0x45, 0x44, 0x00, 0x00, 0x55, 0x00,
0x01, 0x00, 0x7e, 0x01, 0x7e, 0x01, 0x7e, 0x01,
0x7e, 0x01, 0x7e, 0x01, 0x7e, 0x01, 0x80, 0x7f,
0x01, 0x00, 0x7e, 0x39, 0x7e, 0x09, 0x7e, 0x19,
0x7e, 0x11, 0x7e, 0x01, 0x7e, 0x11, 0x80, 0x7f,
0x01, 0x00, 0x7e, 0x09, 0x4e, 0x39, 0x4e, 0x39,
0x7e, 0x09, 0x7e, 0x09, 0x7e, 0x3d, 0x80, 0x7f,
0xfc, 0xfc, 0xfc, 0x84, 0xf8, 0x88, 0xfc, 0x84,
0xfe, 0xa2, 0xdf, 0xd1, 0x0e, 0x0a, 0x04, 0x04,
0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00,
0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00
};

unsigned char game_images_map[17]	= 
					{
					IMAGE_0,IMAGE_1,IMAGE_2,IMAGE_3,IMAGE_4,IMAGE_5,IMAGE_6,IMAGE_7,IMAGE_8,
					IMAGE_MINE,IMAGE_BOOM,IMAGE_MISSED,IMAGE_UNSWEEPED,
					IMAGE_UNSURE,IMAGE_MARK,IMAGE_POINTER,IMAGE_BG
					};

unsigned char menu_images[] =
{
0x00, 0x00, 0x00, 0x00, 0x1c, 0x1c, 0x14, 0x14,
0x14, 0x14, 0x14, 0x14, 0x1c, 0x1c, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x18, 0x18,
0x08, 0x08, 0x08, 0x08, 0x1c, 0x1c, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x1c, 0x1c, 0x04, 0x04,
0x1c, 0x1c, 0x10, 0x10, 0x1c, 0x1c, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x1c, 0x1c, 0x04, 0x04,
0x0c, 0x0c, 0x04, 0x04, 0x1c, 0x1c, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x14, 0x14, 0x14, 0x14,
0x1c, 0x1c, 0x04, 0x04, 0x04, 0x04, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x1c, 0x1c, 0x10, 0x10,
0x1c, 0x1c, 0x04, 0x04, 0x1c, 0x1c, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x1c, 0x1c, 0x10, 0x10,
0x1c, 0x1c, 0x14, 0x14, 0x1c, 0x1c, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x1c, 0x1c, 0x04, 0x04,
0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x1c, 0x1c, 0x14, 0x14,
0x1c, 0x1c, 0x14, 0x14, 0x1c, 0x1c, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x1c, 0x1c, 0x14, 0x14,
0x1c, 0x1c, 0x04, 0x04, 0x1c, 0x1c, 0x00, 0x00,
0xff, 0xff, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xff, 0xff,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xab, 0x01,
0xeb, 0x01, 0xaf, 0x01, 0xab, 0x01, 0xff, 0xff,
0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x00, 0x00, 0x00, 0x00, 0x7e, 0x7e, 0x7e, 0x42,
0x3c, 0x24, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x3c, 0x24,
0x7e, 0x42, 0x7e, 0x7e, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x14, 0x14, 0x22, 0x22,
0x7f, 0x7f, 0x22, 0x22, 0x14, 0x14, 0x00, 0x00,
0x00, 0x00, 0x08, 0x08, 0x1c, 0x1c, 0x2a, 0x2a,
0x08, 0x08, 0x2a, 0x2a, 0x1c, 0x1c, 0x08, 0x08,
0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x1c, 0x08,
0x3c, 0x1e, 0x18, 0x0c, 0x00, 0x08, 0x00, 0x00,
0x00, 0x00, 0x7f, 0x00, 0x7f, 0x0e, 0x7f, 0x0a,
0x7f, 0x0a, 0x7f, 0x0e, 0x7f, 0x00, 0x80, 0x7f,
0x01, 0x00, 0xfe, 0x01, 0xfe, 0xa1, 0xfe, 0xc1,
0xfe, 0xa1, 0xfe, 0xa1, 0xfe, 0x01, 0x00, 0xff,
0x3b, 0x3b, 0x22, 0x22, 0x3b, 0x3b, 0x0a, 0x0a,
0x3b, 0x3b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0xba, 0xba, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12,
0x93, 0x93, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0xb8, 0xb8, 0xa8, 0xa8, 0xb8, 0xb8, 0xa0, 0xa0,
0xa0, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

unsigned char menu_images_map[] =
{
0x2a, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2e, 0x2b,
0x30, 0x39, 0x3a, 0x3b, 0x3c, 0x3c, 0x3c, 0x31,
0x30, 0x34, 0x3c, 0x32, 0x3c, 0x3c, 0x33, 0x31,
0x30, 0x35, 0x3c, 0x32, 0x3c, 0x3c, 0x33, 0x31,
0x30, 0x36, 0x3c, 0x32, 0x3c, 0x3c, 0x33, 0x31,
0x30, 0x3c, 0x3c, 0x3c, 0x3c, 0x37, 0x38, 0x31,
0x2c, 0x2f, 0x2f, 0x2f, 0x2f, 0x2f, 0x2f, 0x2d
};

UBYTE minefield[20][18];
UBYTE checked;
UBYTE running;
UBYTE mines;
UBYTE mines_x[99];
UBYTE mines_y[99];
UBYTE game_max_x;
UBYTE game_max_y;
UBYTE game_mid_x;
UBYTE game_mid_y;
UBYTE menu_scroll;
UBYTE menu_state;
BYTE seek_point_x[SEEK_POINTS]	= {-1, 0, 1, 1, 1, 0,-1,-1};
BYTE seek_point_y[SEEK_POINTS]	= {-1,-1,-1, 0, 1, 1, 1, 0};
fixed random_seed;

BYTE mines_seek(UBYTE x,UBYTE y);
void mines_seek_recursive(UBYTE x,UBYTE y);
void sweep(UBYTE x,UBYTE y,UBYTE mode);
void mines_random(UBYTE ignore_x,UBYTE ignore_y);
void mines_show(UBYTE boom_x,UBYTE boom_y,UBYTE done);
void minefield_redraw();
UBYTE minefield_get(UBYTE x,UBYTE y);
void minefield_set(UBYTE x,UBYTE y,UBYTE name);
void restart();
void menu_show(UBYTE show);
void menu_set_value(UBYTE x,UBYTE y,UBYTE *value,UBYTE min,UBYTE max,BYTE change);


BYTE mines_seek(UBYTE x,UBYTE y)
{
	UBYTE found_mines,temp;
	BYTE xd,yd;
	found_mines=0;
	
	for(temp=0;temp < mines;temp++)
	{
		// compiler bug?
		// rcc: src/gen.c:691: spillee: Assertion `bestreg' failed.
		//xd = x-mines_x[temp];
		//yd = y-mines_y[temp];
		
		if(mines_x[temp] == x && mines_y[temp] == y)
			return -1;
		
		// seams to work this is below the above if statement
		xd = x-mines_x[temp];
		yd = y-mines_y[temp];

		if( (xd < 2 && xd > -2) && (yd < 2 && yd > -2) )
			found_mines++;
	}
	return found_mines;
}

void mines_seek_recursive(UBYTE x,UBYTE y)
{
	UBYTE temp,m,pos;
	BYTE pos_x,pos_y;
	for(temp=0;temp < SEEK_POINTS;temp++)
	{
		pos_x = x+seek_point_x[temp];
		pos_y = y+seek_point_y[temp];
		pos = minefield_get(pos_x,pos_y);
		if(
			(pos_x > -1 && pos_x < game_max_x && pos_y > -1 && pos_y < game_max_y) && 
			(pos == IMAGE_UNSWEEPED || pos == IMAGE_UNSURE || pos == IMAGE_MARK)
		)
		{	
			checked++;
			m = mines_seek(pos_x,pos_y);
			minefield_set(pos_x,pos_y,m);
			if(m == 0)
				mines_seek_recursive(pos_x,pos_y);
		}
	}
}

void sweep(UBYTE x,UBYTE y,UBYTE mode)
{
	UBYTE pos;
	BYTE m;
	
	pos = minefield_get(x,y);
	if(running && (pos == IMAGE_UNSWEEPED || pos == IMAGE_MARK || pos == IMAGE_UNSURE))
	{
		if(mode)
		{
			if(pos == IMAGE_UNSWEEPED)
				minefield_set(x,y,IMAGE_MARK);
			else if(pos == IMAGE_MARK)
				minefield_set(x,y,IMAGE_UNSURE);
			else if(pos == IMAGE_UNSURE)
				minefield_set(x,y,IMAGE_UNSWEEPED);
			return;
		}
		
		if(checked == 0)
			mines_random(x,y);	
		m = mines_seek(x,y);

		if(m == -1)
		{
			mines_show(x,y,FALSE);
			running = FALSE;
			menu_show(TRUE);
			return;
		}
		else if(m == 0)
		{
			checked++;
			minefield_set(x,y,m);
			mines_seek_recursive(x,y);
		}
		else
		{
			checked++;
			minefield_set(x,y,m);
		}	
		if((game_max_x*game_max_y)-checked == mines)
		{
			mines_show(x,y,TRUE);
			running = FALSE;
			menu_show(TRUE);
		}
	}
}

void mines_random(UBYTE ignore_x,UBYTE ignore_y)
{		
	UBYTE i,j,k;
	
	random_seed.b.h = DIV_REG;
	initrand(random_seed.w);
	
	for(i=0;i < mines;i++)
	{
		k = TRUE;
		while(k)
		{
			mines_x[i] = rand()%game_max_x;
			mines_y[i] = rand()%game_max_y;
			if(mines_x[i] == ignore_x && mines_y[i] == ignore_y)
				continue;
			k = FALSE;
			for(j=0;j < i && !k;j++)
				if(mines_x[i] == mines_x[j] && mines_y[i] == mines_y[j])
					k = TRUE;
		}
	}
	
}

void mines_show(UBYTE boom_x,UBYTE boom_y,UBYTE done)
{
	UBYTE temp,x,y,i;
	
	if(done)
		for(temp=0;temp < mines;temp++)
			minefield_set(mines_x[temp],mines_y[temp],IMAGE_MINE);
	else
	{
		for(y=0;y < game_max_y;y++)
			for(x=0;x < game_max_x;x++)
			{
				i = FALSE;
				for(temp=0;temp < mines;temp++)
					if(mines_x[temp] == x && mines_y[temp] == y)
					{
						i = TRUE;
						break;
					}

				if(minefield_get(x,y) == IMAGE_MARK)
					minefield_set(x,y,(i ? IMAGE_MARK : IMAGE_MISSED));
				else if(i)
					minefield_set(x,y,IMAGE_MINE);
			}
		minefield_set(boom_x,boom_y,IMAGE_BOOM);		
	}
}

void minefield_redraw()
{
	UBYTE x,y;

	DISPLAY_OFF;
	
	for(y=0;y < SCREENHEIGHT/8;y++)
		for(x=0;x < SCREENWIDTH/8;x++)
			set_bkg_tiles(x,y,1,1,&game_images_map[IMAGE_BG]);
	
	for(y=0;y < game_max_y;y++)
		for(x=0;x < game_max_x;x++)
			minefield_set(x,y,minefield_get(x,y));

	wait_vbl_done();
	DISPLAY_ON;
}


UBYTE minefield_get(UBYTE x,UBYTE y)
{
	return minefield[x][y];
}


void minefield_set(UBYTE x,UBYTE y,UBYTE image)
{	
	set_bkg_tiles(game_mid_x+x,game_mid_y+y,1,1,&game_images_map[image]);
	minefield[x][y] = image;
}

void restart()
{
	UBYTE x,y;

	running = TRUE;
	checked = 0;
	
	game_mid_x = (20-game_max_x)/2;
	game_mid_y = (18-game_max_y)/2;
	
	for(y=0;y < game_max_y;y++)
		for(x=0;x < game_max_x;x++)
			minefield[x][y] = IMAGE_UNSWEEPED;
}

void menu_show(UBYTE show)
{	
	if(menu_state && show)
		return;
	
	for(menu_scroll=0;menu_scroll < 64;menu_scroll++)
	{	
		scroll_win((menu_state ? 1 : -1),0);
		delay(20);
	}
	menu_state = !menu_state;
}

void menu_set_value(UBYTE x,UBYTE y,UBYTE *value,UBYTE min,UBYTE max,BYTE change)
{
	static unsigned char number_map[] = {32,33,34,35,36,37,38,39,40,41};
	BYTE v;
	
	v = (*value)+change;
	if(v > max)
		v = min;
	if(v < min)
		v = max;
	*value = v;
	
	set_win_tiles(x,y,1,1,number_map+( ((*value)/10) ));
	set_win_tiles(x+1,y,1,1,number_map+( ((*value)%10) ));
}

void main()
{
	UBYTE j;
	UBYTE pointer_x,pointer_y;
	BYTE a_x,a_y;
	UBYTE menu_x,menu_y;
	
	disable_interrupts();
	DISPLAY_OFF;

	pointer_x = pointer_y = 0;
	menu_state = FALSE;
	running = TRUE;
	checked = 0;
	game_max_x = 10;
	game_max_y = 10;
	mines = 10;
	
	BGP_REG = 0xe4;
	OBP0_REG = 0xc0;
	set_bkg_data(0,17,game_images);
	set_win_data(32,28,menu_images);
	set_win_tiles(0,0,8,7,menu_images_map);
	move_win(167,88);	
	set_sprite_data(0,1,game_images+(IMAGE_POINTER*16)); // offset to pointer image
	set_sprite_prop(0,0);
	_MOVE_POINTER(pointer_x,pointer_y);
		
	restart();
	minefield_redraw();
	
	menu_set_value(4,2,&game_max_x,1,20,0);
	menu_set_value(4,3,&game_max_y,1,18,0);
	menu_set_value(4,4,&mines,1,99,0);
	
	SHOW_WIN;
	SHOW_SPRITES;
	SHOW_BKG;

	DISPLAY_ON;
	enable_interrupts();
	
	for(;;)
	{
		delay(20);
		j = joypad();

		if(j & J_SELECT)
		{
			random_seed.b.l = DIV_REG;
			menu_show(FALSE);
		}
			
		if(j & J_UP)
			pointer_y = (pointer_y == 0 ? 143 : pointer_y-1);
		if(j & J_DOWN)
			pointer_y = (pointer_y == 143 ? 0 : pointer_y+1);
		if(j & J_LEFT)
			pointer_x = (pointer_x == 0 ? 159 : pointer_x-1);
		if(j & J_RIGHT)
			pointer_x = (pointer_x == 159 ? 0 : pointer_x+1);

		_MOVE_POINTER(pointer_x,pointer_y);
		
		if(j & J_A)
		{
			if(menu_state && pointer_y > 88 && pointer_x > 96)
			{
				menu_x = (pointer_x-96)/8;
				menu_y = (pointer_y-88)/8;
	
				if(menu_y == 5 && (menu_x == 5 || menu_x == 6))
				{
					if(mines > (game_max_x*game_max_y)-1)
						mines = game_max_x*game_max_y-1;
					menu_set_value(4,4,&mines,1,99,0);
					menu_show(FALSE);
					restart();
					minefield_redraw();
				}
				else if(menu_y == 2 && (menu_x == 3 || menu_x == 6))
					menu_set_value(4,2,&game_max_x,1,20,(menu_x == 3 ? -1 : 1));
				else if(menu_y == 3 && (menu_x == 3 || menu_x == 6))
					menu_set_value(4,3,&game_max_y,1,18,(menu_x == 3 ? -1 : 1));
				else if(menu_y == 4 && (menu_x == 3 || menu_x == 6))
					menu_set_value(4,4,&mines,1,99,(menu_x == 3 ? -1 : 1));
			}
			else
			{
				a_x = (pointer_x/8)-game_mid_x;
				a_y = (pointer_y/8)-game_mid_y;
				if(a_x > -1 && a_y > -1 && a_x < game_max_x && a_y < game_max_y)
					sweep((pointer_x/8)-game_mid_x,(pointer_y/8)-game_mid_y,j & J_B);
			}
			delay(200);
		}
	}
}

